# =============================================================================
# AWS Cloud Account and S3 Configuration
# =============================================================================
# See README.md for Cloud Account and IAM policy setup instructions.
buckets:
  cloudAccountName: kintsugi-aws-dev    # Name of your configured Cloud Account
  awsPolicyRefs:                        # IAM policies for S3 access
    - aws::AmazonS3ReadOnlyAccess       # Note: if using a custom policy, omit the aws:: prefix as this is only for AWS managed policies
  awsRegion: us-west-2                  # Region of your S3 bucket
  sourceBucket: manticore-imports       # S3 bucket containing files to import

# =============================================================================
# Tables Configuration
# =============================================================================
# See README.md for table structure, column types, and config options.
# Add/remove tables as needed.
tables:
  - name: addresses
    csvPath:
      - addresses_small.tsv
    config:
      haStrategy: noerrors
      agentRetryCount: 3
      clusterMain: false
      segmentCount: 1
      importMethod: indexer
      charsetTable: non_cont
      memLimit: 2G
      hasHeader: true
    schema:
      columns:
        - name: record_hash
          type: attr_string
        - name: number
          type: attr_string
        - name: street
          type: field
        - name: street2
          type: field
        - name: city
          type: field
        - name: state
          type: attr_string
        - name: country
          type: attr_string
        - name: county
          type: field
        - name: latitude
          type: attr_float
        - name: longitude
          type: attr_float
        - name: postal_code
          type: attr_string
        - name: address
          type: field
        - name: full_address
          type: field
        - name: created_at
          type: attr_timestamp
        - name: is_unincorporated
          type: attr_bool
        - name: source
          type: attr_string
        - name: updated_at
          type: attr_timestamp

# =============================================================================
# Manticore Search Configuration
# =============================================================================
manticore:
  image: manticoresearch/manticore:15.1.0
  clusterName: manticore          # Galera cluster name
  allowExternalAccess: true       # true = Manticore HTTP/MySQL ports reachable externally; false = internal only
  resources:
    cpu: 4
    memory: 8Gi
  volumeset:
    capacity: 200                 # GB per replica
  sharedVolumeset:
    capacity: 100                 # GB shared across replicas and orchestrator

  # minScale = replica count used by orchestrator for coordination
  autoscaling:
    minScale: 3
    maxScale: 4
    metric: rps                   # rps for stateful, cpu for standard
    target: 100
    scaleToZeroDelay: 300

  rolloutOptions:
    maxSurgeReplicas: 25%
    maxUnavailableReplicas: '0'
    minReadySeconds: 10
    scalingPolicy: OrderedReady
    terminationGracePeriodSeconds: 60

  # IMPORTANT: same-gvc required for Galera replication
  firewall:
    internalAccess:
      type: same-gvc
      workloads: []

# =============================================================================
# Orchestrator Configuration
# =============================================================================
orchestrator:
  version: v5.0.0
  image: ghcr.io/controlplane-com/manticore-orchestrator/manticore-cpln-api
  logLevel: debug                 # debug, info, warn, error
  resources:
    cpu: 1
    memory: 2Gi

  # Cron job settings
  schedule: "0 * * * *"           # Cron schedule (default = every hour)
  action: import                  # init, import, health, repair
  tableName: addresses            # Must match a name in tables[]
  suspend: true                   # Start suspended (trigger via UI/API)
  timeoutSeconds: 900             # Container timeout (seconds, default 15 minutes)
  importMemLimit: 2G              # Memory limit for import jobs
  activeDeadlineSeconds: 14400    # Max job runtime (seconds, default 4 hours)

  # Orchestrator API
  api:
    version: v5.0.0
    image: ghcr.io/controlplane-com/manticore-orchestrator/manticore-cpln-api
    logLevel: debug
    importPollInterval: 30s
    importPollTimeout: 2h
    resources:
      cpu: 0.25
      memory: 256Mi
    allowExternalAccess: true
    autoscaling:
      maxScale: 3
      minScale: 2
      metric: cpu
      target: 80

  # Agent sidecar
  agent:
    version: v5.0.0
    image: ghcr.io/controlplane-com/manticore-orchestrator/manticore-cpln-agent
    # REQUIRED: Generate with `openssl rand -base64 32`
    token: ""
    resources:
      cpu: 250m
      minCpu: 100m
      memory: 512Mi
      minMemory: 128Mi
    import:
      batchSize: 20000            # Rows per INSERT statement
    recovery:
      maxRetries: 5               # Retry attempts for cluster recovery
      initialBackoffSec: 5        # Initial delay between retries
      maxBackoffSec: 60           # Max backoff delay (exponential)

  # Web UI - See README.md "Authentication" section for security notes
  ui:
    version: v5.0.0
    image: ghcr.io/controlplane-com/manticore-orchestrator/manticore-cpln-ui
    resources:
      cpu: 0.25
      memory: 0.25Gi
    allowExternalAccess: true     # false = internal GVC access only
    autoscaling:
      maxScale: 2
      minScale: 1
      metric: cpu
      target: 80

  # Backup Configuration (Optional) - Cron job runs logical backup on delta table to S3 bucket.
  backup:
    enabled: false
    version: v5.0.0
    image: ghcr.io/controlplane-com/manticore-orchestrator/manticore-cpln-backup
    cloudAccountName: kintsugi-aws-dev
    s3Bucket: address-validation-manticore-backup    # S3 bucket for backups
    s3Policy:                     # IAM policies for S3 access
      - manticore_search_s3_bucket_access_policy         # Custom policy created in S3 setup instructions
    s3Region: us-west-2
    dataSet: addresses            # Data set to back up
    prefix: manticore-backups     # S3 prefix/folder for backups
    allowExternalAccess: true
    schedules: [
      {"table":"addresses","type":"delta","schedule":"0 2 * * *"},     # Daily at 2am UTC
      {"table":"addresses","type":"main","schedule":"0 2 1 * *"}       # Monthly full backup on 1st at 2am UTC
      ]
    activeDeadlineSeconds: 14400  # Max job runtime (seconds, default 4 hours)
    resources:
      cpu: 1
      memory: 1Gi

# =============================================================================
# Domain Configuration (Optional)
# =============================================================================
# Routes /api/* to orchestrator-api, everything else to UI.
domain:
  enabled: false
  name: ""                        # FQDN, e.g., manticore.example.com
  dnsMode: cname                  # cname (subdomains) or ns (zone delegation)

# =============================================================================
# Load Testing Configuration (Optional)
# =============================================================================
loadTest:
  enabled: false
  image: grafana/k6:0.47.0
  resources:
    cpu: 0.5
    memory: 512Mi
  vus: 10                         # Virtual users
  duration: "5m"                  # Test duration (e.g., 30s, 5m, 1h)
  rps: null                       # Target RPS (null = unlimited)
  replicas: 1                     # Number of k6 pods to spawn

  controller:
    image: alpine/curl            # Alpine image with curl pre-installed
    schedule: ""                  # Cron expression (empty = manual only)
    testDurationBuffer: 60        # Seconds added to duration before scale-down

  target:
    port: 9308                    # Manticore HTTP API port
    endpoint: search              # "search" or "sql"

  # Full JSON body for /search endpoint
  query:
    index: addresses
    query:
      match:
        "*": "test"
    limit: 10
  allowExternalAccess: true
  thresholds:
    p95ResponseTime: 500          # ms
    errorRate: 0.01               # 1%
